<!DOCTYPE html>
<html>
  <head>
    <title>Spawner: Pod is Starting</title>
    <link rel="shortcut icon" href="/favicon.png"/>
    <meta charset="UTF-8">

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@200;400;600&display=swap');

      body {
        font-family: Poppins, sans-serif;
        background: rgb(223, 223, 223);
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      body, html {
        width: 100%;
        height: 100%;
      }

      .img-container {
        display: flex;
        justify-content: center;
        height: 50px;
      }

      main {
        position: relative;
        display: flex;
        justify-content: center;
      }

      .content {
        transition: opacity 200ms ease-out 200ms;
        opacity: 1;
      }

      .error-container {
        position: absolute;
        top: 0;
        color: #c64d4d;
        padding: 13px 20px;
        background-color: #e1d0d0;
        border-radius: 6px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease-out 400ms;
      }

      main.error .content {
        opacity: 0;
        pointer-events: none;
      }

      main.error .error-container {
        opacity: 1;
        pointer-events: initial;
      }

      p {
        transition: color 200ms linear;
      }

      .pending {
        color: #bbb;
      }
    </style>
  </head>
  <body>
    <div>
      <div class="img-container">
        <svg height="100%" viewBox="0 0 489 101" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21.1 91C18.8333 91 16.7333 90.8667 14.8 90.6C12.9333 90.4 12 90.3 12 90.3V81.6C12 81.6 12.4 81.6333 13.2 81.7C14.0667 81.7667 15.1 81.8667 16.3 82C17.5667 82.0667 18.7667 82.1 19.9 82.1C25.0333 82.1 29.1 80.8333 32.1 78.3C35.1667 75.7667 36.7 71.4 36.7 65.2V16H46.5V65.2C46.5 73.0667 44.3333 79.3333 40 84C35.7333 88.6667 29.4333 91 21.1 91Z" fill="#363453"/>
          <path d="M78.4844 36C81.8177 36 84.6177 36.5333 86.8844 37.6C89.151 38.6667 90.9844 39.9333 92.3844 41.4C93.7844 42.8 94.851 44.1333 95.5844 45.4H96.1844V37H105.684V90H96.1844V81.6H95.5844C94.851 82.8667 93.7844 84.2333 92.3844 85.7C90.9844 87.1667 89.151 88.4333 86.8844 89.5C84.6177 90.5 81.8177 91 78.4844 91C74.4844 91 70.9844 90.2333 67.9844 88.7C64.9844 87.1 62.4844 85 60.4844 82.4C58.4844 79.7333 56.9844 76.7667 55.9844 73.5C54.9844 70.2333 54.4844 66.9 54.4844 63.5C54.4844 60.1 54.9844 56.7667 55.9844 53.5C56.9844 50.2333 58.4844 47.3 60.4844 44.7C62.4844 42.0333 64.9844 39.9333 67.9844 38.4C70.9844 36.8 74.4844 36 78.4844 36ZM80.0844 44.1C76.551 44.1 73.5844 45.0667 71.1844 47C68.7844 48.8667 66.9844 51.2667 65.7844 54.2C64.651 57.1333 64.0844 60.2333 64.0844 63.5C64.0844 66.7 64.651 69.8 65.7844 72.8C66.9844 75.7333 68.7844 78.1667 71.1844 80.1C73.5844 81.9667 76.551 82.9 80.0844 82.9C83.6177 82.9 86.551 81.9667 88.8844 80.1C91.2844 78.1667 93.051 75.7333 94.1844 72.8C95.3844 69.8 95.9844 66.7 95.9844 63.5C95.9844 60.2333 95.3844 57.1333 94.1844 54.2C93.051 51.2667 91.2844 48.8667 88.8844 47C86.551 45.0667 83.6177 44.1 80.0844 44.1Z" fill="#363453"/>
          <path d="M115.645 90V37H125.145V44.7H125.545C126.078 43.7 126.911 42.5333 128.045 41.2C129.178 39.8 130.711 38.6 132.645 37.6C134.645 36.5333 137.145 36 140.145 36C144.078 36 147.378 36.9667 150.045 38.9C152.778 40.7667 154.811 43.3 156.145 46.5H156.245C157.711 43.5667 159.778 41.1 162.445 39.1C165.178 37.0333 168.711 36 173.045 36C178.778 36 183.178 37.9667 186.245 41.9C189.378 45.7667 190.945 50.7667 190.945 56.9V90H181.445V57.4C181.445 53.4667 180.511 50.3 178.645 47.9C176.778 45.4333 174.078 44.2 170.545 44.2C167.478 44.2 165.011 45.0333 163.145 46.7C161.345 48.3667 160.045 50.4333 159.245 52.9C158.445 55.3667 158.045 57.8333 158.045 60.3V90H148.545V57.4C148.545 53.4667 147.611 50.3 145.745 47.9C143.945 45.4333 141.245 44.2 137.645 44.2C134.578 44.2 132.111 45.0333 130.245 46.7C128.445 48.3667 127.145 50.4667 126.345 53C125.545 55.4667 125.145 57.9 125.145 60.3V90H115.645Z" fill="#363453"/>
          <path d="M220.302 91C216.236 91 212.869 90.4333 210.202 89.3C207.602 88.1667 205.536 86.7667 204.002 85.1C202.469 83.3667 201.336 81.6667 200.602 80C199.869 78.2667 199.402 76.8333 199.202 75.7C199.002 74.5667 198.902 74 198.902 74H208.502C208.502 74 208.602 74.4667 208.802 75.4C209.069 76.2667 209.569 77.3 210.302 78.5C211.102 79.6333 212.302 80.6667 213.902 81.6C215.569 82.4667 217.769 82.9 220.502 82.9C223.636 82.9 226.069 82.1667 227.802 80.7C229.536 79.1667 230.402 77.3 230.402 75.1C230.402 73.1667 229.702 71.6333 228.302 70.5C226.969 69.3667 225.036 68.5 222.502 67.9L215.302 66.2C212.636 65.5333 210.136 64.6333 207.802 63.5C205.469 62.3667 203.569 60.8333 202.102 58.9C200.702 56.9 200.002 54.4333 200.002 51.5C200.002 46.9667 201.702 43.2667 205.102 40.4C208.502 37.4667 212.936 36 218.402 36C222.069 36 225.102 36.5333 227.502 37.6C229.902 38.6 231.802 39.8667 233.202 41.4C234.669 42.9333 235.736 44.4667 236.402 46C237.136 47.5333 237.602 48.8333 237.802 49.9C238.002 50.9 238.102 51.4 238.102 51.4H228.902C228.902 51.4 228.802 51.0333 228.602 50.3C228.402 49.5 227.936 48.6333 227.202 47.7C226.536 46.7 225.502 45.8333 224.102 45.1C222.702 44.3 220.836 43.9 218.502 43.9C215.302 43.9 212.969 44.6333 211.502 46.1C210.036 47.5667 209.302 49.1667 209.302 50.9C209.302 52.5667 209.969 53.9333 211.302 55C212.702 56 214.502 56.7667 216.702 57.3L224.002 59C228.536 60.0667 232.269 61.8333 235.202 64.3C238.202 66.7 239.702 70.1667 239.702 74.7C239.702 77.6333 238.936 80.3667 237.402 82.9C235.869 85.3667 233.669 87.3333 230.802 88.8C227.936 90.2667 224.436 91 220.302 91Z" fill="#363453"/>
          <path d="M271.807 91C266.14 91 261.374 89.7 257.507 87.1C253.64 84.4333 250.707 81 248.707 76.8C246.707 72.6 245.707 68.1667 245.707 63.5C245.707 58.7667 246.707 54.3333 248.707 50.2C250.707 46 253.64 42.6 257.507 40C261.374 37.3333 266.14 36 271.807 36C277.474 36 282.24 37.3333 286.107 40C289.974 42.6 292.907 46 294.907 50.2C296.907 54.3333 297.907 58.7667 297.907 63.5C297.907 68.1667 296.907 72.6 294.907 76.8C292.907 81 289.974 84.4333 286.107 87.1C282.24 89.7 277.474 91 271.807 91ZM271.807 82.7C275.407 82.7 278.407 81.8 280.807 80C283.274 78.1333 285.107 75.7333 286.307 72.8C287.574 69.8667 288.207 66.7667 288.207 63.5C288.207 60.1667 287.574 57.0667 286.307 54.2C285.107 51.2667 283.274 48.9 280.807 47.1C278.407 45.2333 275.407 44.3 271.807 44.3C268.274 44.3 265.274 45.2333 262.807 47.1C260.34 48.9 258.474 51.2667 257.207 54.2C256.007 57.0667 255.407 60.1667 255.407 63.5C255.407 66.7667 256.007 69.8667 257.207 72.8C258.474 75.7333 260.34 78.1333 262.807 80C265.274 81.8 268.274 82.7 271.807 82.7Z" fill="#363453"/>
          <path d="M329.479 91C325.146 91 321.346 90.2333 318.079 88.7C314.812 87.1 312.079 85 309.879 82.4C307.746 79.7333 306.112 76.7667 304.979 73.5C303.912 70.2333 303.379 66.9 303.379 63.5C303.379 60.1 303.912 56.8 304.979 53.6C306.046 50.3333 307.646 47.3667 309.779 44.7C311.979 42.0333 314.712 39.9333 317.979 38.4C321.246 36.8 325.079 36 329.479 36C333.746 36 337.279 36.6333 340.079 37.9C342.879 39.1667 345.112 40.7667 346.779 42.7C348.512 44.5667 349.779 46.4667 350.579 48.4C351.446 50.2667 352.012 51.8333 352.279 53.1C352.546 54.3667 352.679 55 352.679 55H343.479C343.479 55 343.312 54.4667 342.979 53.4C342.646 52.2667 342.012 51 341.079 49.6C340.146 48.2 338.746 46.9667 336.879 45.9C335.012 44.7667 332.546 44.2 329.479 44.2C325.812 44.2 322.712 45.1333 320.179 47C317.712 48.8 315.846 51.1667 314.579 54.1C313.379 57.0333 312.779 60.1667 312.779 63.5C312.779 66.8333 313.379 69.9667 314.579 72.9C315.846 75.8333 317.712 78.2333 320.179 80.1C322.712 81.9 325.812 82.8 329.479 82.8C332.546 82.8 335.012 82.2667 336.879 81.2C338.746 80.0667 340.146 78.8 341.079 77.4C342.012 76 342.646 74.7667 342.979 73.7C343.312 72.5667 343.479 72 343.479 72H352.679C352.679 72 352.546 72.6333 352.279 73.9C352.012 75.1667 351.446 76.7667 350.579 78.7C349.779 80.5667 348.512 82.4667 346.779 84.4C345.112 86.2667 342.879 87.8333 340.079 89.1C337.279 90.3667 333.746 91 329.479 91Z" fill="#363453"/>
          <path d="M467.07 91C461.604 91 457.47 89.6 454.67 86.8C451.937 84 450.57 80.0667 450.57 75V44.8H441.07V37H450.57V23.7H460.07V37H472.97V44.8H460.07V75C460.07 77.6667 460.804 79.6333 462.27 80.9C463.737 82.1 465.87 82.7 468.67 82.7C470.137 82.7 471.537 82.6 472.87 82.4C474.204 82.2 474.87 82.1 474.87 82.1V90.2C474.87 90.2 474.104 90.3333 472.57 90.6C471.037 90.8667 469.204 91 467.07 91Z" fill="#363453"/>
          <path d="M361.707 90V14H371.207V90H361.707Z" fill="#363453"/>
          <path d="M371 61L392 38H405L380 64L405 90H392L371 67C369.107 64.7304 369.07 63.4068 371 61Z" fill="#363453"/>
          <g filter="url(#filter0_ii_10_59)"><path fill-rule="evenodd" clip-rule="evenodd" d="M441 61L420 38H407V51H416C418.209 51 420 52.7909 420 55C420 57.2091 418.209 59 416 59H407V69H416C418.209 69 420 70.7909 420 73C420 75.2091 418.209 77 416 77H407V90H420L441 67C443.01 64.5289 443.005 63.2036 441 61Z" fill="#9F007C"/></g>
          <defs>
            <filter id="filter0_ii_10_59" x="405" y="35" width="39.5056" height="58" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
              <feFlood flood-opacity="0" result="BackgroundImageFix"/>
              <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
              <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
              <feOffset dx="-2" dy="-3"/>
              <feGaussianBlur stdDeviation="2"/>
              <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1"/>
              <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
              <feBlend mode="normal" in2="shape" result="effect1_innerShadow_10_59"/>
              <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
              <feOffset dx="2" dy="3"/>
              <feGaussianBlur stdDeviation="2"/>
              <feComposite in2="hardAlpha" operator="arithmetic" k2="-1" k3="1"/>
              <feColorMatrix type="matrix" values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.25 0"/>
              <feBlend mode="normal" in2="effect1_innerShadow_10_59" result="effect2_innerShadow_10_59"/>
            </filter>
          </defs>
        </svg>
      </div>
      <main>
        <div class="content">
          <p>Waiting for backend to spawn. You will be redirected when it does.</p>
          <p>
            <span id="constructed" class="pending">Constructed</span> •
            <span id="scheduled" class="pending">Scheduled</span> •
            <span id="running" class="pending">Running</span> •
            <span id="ready" class="pending">Ready</span>
          </p>
        </div>
        <p class="error-container"></p>
      </main>
    </div>
    <script>
      // ---- CUSTOMIZE SPAWN / REDIRECT LOGIC BELOW ----˅˅˅

      const SPAWN_TOKEN = '[SPAWN TOKEN HERE]'
      const SPAWN_ENV = {
        JAMSOCKET_JUPYTER_TOKEN: 'asdf'
      }
      spawn(SPAWN_TOKEN, SPAWN_ENV).then(url => {
        document.location = `${url}?token=${encodeURIComponent(SPAWN_ENV.JAMSOCKET_JUPYTER_TOKEN)}`
      }).catch(err => {
        const errMessageElem = document.querySelector('.error-container')
        errMessageElem.innerText = err.message
        const mainElem = document.querySelector('main')
        mainElem.classList.add('error')
      })

      // ---- CUSTOMIZE SPAWN / REDIRECT LOGIC ABOVE ----^^^

      function spawn(spawnToken, spawnEnv) {
        if (spawnEnv) validateEnv(spawnEnv)
        return new Promise((resolve, reject) => {
          const API_BASE = 'https://jamsocket.dev'
          const spawnEndpoint = `${API_BASE}/api/token/${spawnToken}/spawn`

          // append #nocache to the URL to force a flush of localStorage up front
          if (document.location.hash === '#nocache') {
            document.location.hash = ''
            console.log('URL includes #nocache. Removing localStorage for spawnToken:', spawnToken)
            localStorage.removeItem(spawnToken)
          }

          let spawnState
          readSpawnState().then(state => {
            if (state) return state
            const body = spawnEnv ? { env: spawnEnv } : {}
            const startTime = Date.now()
            return fetch(spawnEndpoint, {
              method: 'POST',
              headers: new Headers({ 'Content-Type': 'application/json' }),
              mode: 'cors',
              body: JSON.stringify(body)
            }).then(res => res.json())
              .then(res => {
                if (res.error) {
                  const { code, id, message, status } = res.error
                  throw new Error(`${status} ${code}: ${message} (${id})`)
                }
                // Successful spawn response looks like this:
                // {
                //   "url": "https://[NAME].jamsocket.dev",
                //   "name": "[NAME]",
                //   "ready_url": "https://jamsocket.dev/ready/[NAME]/",
                //   "status_url": "https://jamsocket.dev/api/backend/[NAME]/status"
                // }
                console.log('spawning backend', res)
                return {
                  time: startTime,
                  spawnToken: spawnToken,
                  spawnEnv: spawnEnv,
                  spawnResponse: res,
                  receivedEvents: [],
                  isReady: false,
                  isFailed: false
                }
              })
          }).then(state => {
            spawnState = state
            saveSpawnState(spawnState)

            for (const event of spawnState.receivedEvents) {
              if (event.status === 'Ready') {
                onReady(spawnState)
                return
              }
              updateEventUI(event)
            }

            const eventSource = new EventSource(`${spawnState.spawnResponse.status_url}/stream`)
            eventSource.onmessage = (event) => {
              // events data look like: {"state": "Constructed","time": "2022-03-01T18:11:17.689823Z"}
              // possible event states: "Constructed", "Scheduled", "Running", "Ready", "Swept"
              const eventData = JSON.parse(event.data)
              addEventToSpawnState(spawnState, eventData)
              updateEventUI(eventData)
              if (eventData.state == 'Ready') {
                onReady(spawnState)
              }
            }
          }).catch((err) => {
            if (spawnState) {
              spawnState.isFailed = true
              spawnState.isReady = false
              saveSpawnState(spawnState)
            }
            reject(err)
          })

          function onReady(state) {
            state.isReady = true
            saveSpawnState(state)
            resolve(state.spawnResponse.url)
          }

          function updateEventUI(event) {
            const elem = document.getElementById(event.state.toLowerCase())
            if (!elem) {
              console.warn(`Received event with no corresponding UI element: ${event}`)
              return
            }
            elem.classList.remove('pending')
          }

          function saveSpawnState(spawnState) {
            localStorage.setItem(spawnToken, JSON.stringify(spawnState))
          }

          // reads previous spawn state from localStorage and uses it if the spawned instance
          // is still active. If no previous state exists, the previous spawn failed, or the
          // spawned instance is no longer running, this function returns a Promise that
          // resolves to null
          function readSpawnState() {
            const storedState = localStorage.getItem(spawnToken)
            if (!storedState) return Promise.resolve(null)
            let state
            try {
              state = JSON.parse(storedState)
              console.log('found state in localStorage:', state)
              // if the saved state is for a failed spawn, remove the state from localStorage now
              if (state.isFailed) {
                console.log('previous spawned session failed, ignoring saved state')
                localStorage.removeItem(spawnToken)
                return Promise.resolve(null)
              }
            } catch (error) {
              console.warn(error)
              console.warn(`Error parsing localStorage for spawnToken ${spawnToken}: ${storedState}`)
              localStorage.removeItem(spawnToken)
              return Promise.resolve(null)
            }
            return fetch(state.spawnResponse.status_url, { mode: 'cors' })
              .then(res => res.json())
              .then(res => {
                if (!res || res.state === 'Swept') {
                  console.log(`previous spawned session no longer exists: ${res}`)
                  localStorage.removeItem(spawnToken)
                  return null
                }
                return state
              })
              .catch((error) => {
                console.warn(`error fetching status: ${error}`)
                console.log('clearing localStorage and ignoring previous state')
                localStorage.removeItem(spawnToken)
                return null
              })
          }

          function addEventToSpawnState(state, event) {
            for (const evt of state.receivedEvents) {
              if (evt.state === event.state && evt.time === event.time) return
            }
            state.receivedEvents.push(event)
            saveSpawnState(state)
          }
        })

        function validateEnv(spawnEnv) {
            for (const key of Object.keys(spawnEnv)) {
              if (!key.startsWith('JAMSOCKET_')) {
                throw new Error(`spawn env variables must be prefixed with "JAMSOCKET_". Found invalid key: ${key}`)
              }
            }
          }
      }
    </script>
  </body>
</html>
